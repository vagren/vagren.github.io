<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端监控 SDK 的一些技术要点原理分析 | WebCourse</title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/assets/style.49eed234.css">
    <link rel="modulepreload" href="/assets/Home.e02e0cd4.js">
    <link rel="modulepreload" href="/assets/app.79b189f8.js">
    <link rel="modulepreload" href="/assets/net_监控_前端监控 SDK 的一些技术要点原理分析.md.94fb4204.lean.js">
    
    <meta name="twitter:title" content="前端监控 SDK 的一些技术要点原理分析 | WebCourse">
  <meta property="og:title" content="前端监控 SDK 的一些技术要点原理分析 | WebCourse">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="WebCourse, back to home" data-v-675d8756 data-v-cc01ef16><!----> WebCourse</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><!----></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><!----><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#数据采集与上报">数据采集与上报</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#性能">性能</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#错误数据采集">错误数据采集</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#行为数据采集">行为数据采集</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#数据上报">数据上报</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#总结">总结</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#参考">参考</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#数据整理和存储">数据整理和存储</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#数据展示">数据展示</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="前端监控-sdk-的一些技术要点原理分析" tabindex="-1">前端监控 SDK 的一些技术要点原理分析 <a class="header-anchor" href="#前端监控-sdk-的一些技术要点原理分析" aria-hidden="true">#</a></h1><p>一个完整的前端监控平台包括三个部分：数据采集与上报、数据整理和存储、数据展示。</p><p><img src="/assets/0a8d6ccb9e5de6fe39baa78d24b0bba9f59612c176dbd83ee2e4a4082a7d24ff.0a8d6ccb.png" alt="picture 1"></p><p><img src="/assets/e031a7b6b39a1db28dadea81f9c188249b459336d2a697d7d6fda8579c089edf.e031a7b6.png" alt="picture 2"></p><h2 id="数据采集与上报" tabindex="-1">数据采集与上报 <a class="header-anchor" href="#数据采集与上报" aria-hidden="true">#</a></h2><p>chrome 开发团队提出了一系列用于检测网页性能的指标：</p><ul><li>FP(first-paint)，从页面加载开始到第一个像素绘制到屏幕上的时间</li><li>FCP(first-contentful-paint)，从页面加载开始到页面内容的任何部分在屏幕上完成渲染的时间</li><li>LCP(largest-contentful-paint)，从页面加载开始到最大文本块或图像元素在屏幕上完成渲染的时间</li><li>CLS(layout-shift)，从页面加载开始和其生命周期状态变为隐藏期间发生的所有意外布局偏移的累积分数</li></ul><p>这四个性能指标都需要通过 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FPerformanceObserver" target="_blank" rel="noopener noreferrer">PerformanceObserver</a> 来获取（也可以通过 <code>performance.getEntriesByName()</code> 获取，但它不是在事件触发时通知的）。PerformanceObserver 是一个性能监测对象，用于监测性能度量事件。</p><h3 id="性能" tabindex="-1">性能 <a class="header-anchor" href="#性能" aria-hidden="true">#</a></h3><h4 id="fp" tabindex="-1">FP <a class="header-anchor" href="#fp" aria-hidden="true">#</a></h4><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;first-paint&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span>
<span class="token comment">// buffered 属性表示是否观察缓存数据，也就是说观察代码添加时机比事情触发时机晚也没关系。</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;paint&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>通过以上代码可以得到 FP 的内容:</p><div class="language-js line-numbers-mode"><pre><code><span class="token punctuation">{</span>
    <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entryType</span><span class="token operator">:</span> <span class="token string">&quot;paint&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;first-paint&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">startTime</span><span class="token operator">:</span> <span class="token number">359</span><span class="token punctuation">,</span> <span class="token comment">// fp 时间</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="fcp" tabindex="-1">FCP <a class="header-anchor" href="#fcp" aria-hidden="true">#</a></h4><p>FCP(first-contentful-paint)，从页面加载开始到页面内容的任何部分在屏幕上完成渲染的时间。对于该指标，&quot;内容&quot;指的是文本、图像（包括背景图像）、<code>&lt;svg&gt;</code>元素或非白色的<code>&lt;canvas&gt;</code>元素。 <img src="/assets/276e4bb6e16ccd878de6e002f3023b539d578aee537967e9c00601cf6027655b.276e4bb6.png" alt="picture 3"></p><p><img src="/assets/2d128abae6ca349155f3237fde485911ec4dea00de5fe847c5830390c469ada0.2d128aba.png" alt="picture 6"></p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;first-contentful-paint&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;paint&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>output</p><div class="language-js line-numbers-mode"><pre><code><span class="token punctuation">{</span>
    <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entryType</span><span class="token operator">:</span> <span class="token string">&quot;paint&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;first-contentful-paint&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">startTime</span><span class="token operator">:</span> <span class="token number">459</span><span class="token punctuation">,</span> <span class="token comment">// fcp 时间</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="lcp" tabindex="-1">LCP <a class="header-anchor" href="#lcp" aria-hidden="true">#</a></h4><p>LCP(largest-contentful-paint)，从页面加载开始到最大文本块或图像元素在屏幕上完成渲染的时间。LCP 指标会根据页面首次开始加载的时间点来报告可视区域内可见的最大图像或文本块完成渲染的相对时间。</p><p>一个良好的 LCP 分数应该控制在 2.5 秒以内。</p><p><img src="/assets/e7432cc997919d928d732f332b3ce6e489bdb569f61aca3328ef690572358497.e7432cc9.png" alt="picture 7"></p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;largest-contentful-paint&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>output:</p><div class="language-js line-numbers-mode"><pre><code><span class="token punctuation">{</span>
    <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">element</span><span class="token operator">:</span> p<span class="token punctuation">,</span> <span class="token comment">// 指 LCP 绘制的 DOM 元素</span>
    <span class="token literal-property property">entryType</span><span class="token operator">:</span> <span class="token string">&quot;largest-contentful-paint&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">loadTime</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">renderTime</span><span class="token operator">:</span> <span class="token number">1021.299</span><span class="token punctuation">,</span>
    <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">37932</span><span class="token punctuation">,</span>
    <span class="token literal-property property">startTime</span><span class="token operator">:</span> <span class="token number">1021.299</span><span class="token punctuation">,</span> <span class="token comment">// 绘制时间</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/assets/493b77a3981f468fe456ddcb0c29d20fb2df0e647f9a597af4449f9db743f2a3.493b77a3.png" alt="picture 8"></p><p>LCP 考察的元素类型为：</p><ul><li><code>&lt;img&gt;</code>元素</li><li>内嵌在<code>&lt;svg&gt;</code>元素内的<code>&lt;image&gt;</code>元素</li><li><code>&lt;video&gt;</code>元素（使用封面图像）</li><li>通过<code>url()</code>函数（而非使用CSS 渐变）加载的带有背景图像的元素</li><li>包含文本节点或其他行内级文本元素子元素的块级元素。</li></ul><h4 id="cls" tabindex="-1">CLS <a class="header-anchor" href="#cls" aria-hidden="true">#</a></h4><p>CLS(layout-shift)，从页面加载开始和其生命周期状态变为隐藏期间发生的所有意外布局偏移的累积分数。</p><p>布局偏移分数的计算方式如下：</p><div class="language-"><pre><code>布局偏移分数 = 影响分数 * 距离分数
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>影响分数测量不稳定元素对两帧之间的可视区域产生的影响。</p></blockquote><blockquote><p>距离分数指的是任何不稳定元素在一帧中位移的最大距离（水平或垂直）除以可视区域的最大尺寸维度（宽度或高度，以较大者为准）。</p></blockquote><p>CLS 就是把所有布局偏移分数加起来的总和。</p><p>当一个 DOM 在两个渲染帧之间产生了位移，就会触发 CLS（如图所示）。</p><p><img src="/assets/f4f8cc783a233e28c8b789403b4453e83df4c403d819bef33b6e4ab57a3a2559.f4f8cc78.png" alt="picture 9"><br><img src="/assets/8ad2ff9b8c99caa5d1c4f79bf391b69777714f362583b84718927417aeff75b6.8ad2ff9b.png" alt="picture 10"><br> 上图中的矩形从左上角移动到了右边，这就算是一次布局偏移。同时，在 CLS 中，有一个叫会话窗口的术语：一个或多个快速连续发生的单次布局偏移，每次偏移相隔的时间少于 1 秒，且整个窗口的最大持续时长为 5 秒。</p><p><img src="/assets/afd2fbd3b86a9a4f5b743c2150a8ac6a437871b4dc1f5eb1f5d63c0aaa90451b.afd2fbd3.png" alt="picture 11"></p><p>例如上图中的第二个会话窗口，它里面有四次布局偏移，每一次偏移之间的间隔必须少于 1 秒，并且第一个偏移和最后一个偏移之间的时间不能超过 5 秒，这样才能算是一次会话窗口。如果不符合这个条件，就算是一个新的会话窗口。可能有人会问，为什么要这样规定？其实这是 chrome 团队根据大量的实验和研究得出的分析结果 Evolving the CLS metric。 CLS 一共有三种计算方式：</p><ul><li>累加</li><li>取所有会话窗口的平均数</li><li>取所有会话窗口中的最大值</li></ul><h5 id="累加" tabindex="-1">累加 <a class="header-anchor" href="#累加" aria-hidden="true">#</a></h5><p>也就是把从页面加载开始的所有布局偏移分数加在一起。但是这种计算方式对生命周期长的页面不友好，页面存留时间越长，CLS 分数越高。</p><h5 id="取所有会话窗口的平均数" tabindex="-1">取所有会话窗口的平均数 <a class="header-anchor" href="#取所有会话窗口的平均数" aria-hidden="true">#</a></h5><p>这种计算方式不是按单个布局偏移为单位，而是以会话窗口为单位。将所有会话窗口的值相加再取平均值。但是这种计算方式也有缺点。</p><p><img src="/assets/f65b4e97558172a262ad5ab61da48cd9c742529731f5b85759f87ef90e18b1c7.f65b4e97.png" alt="picture 12"><br> 从上图可以看出来，第一个会话窗口产生了比较大的 CLS 分数，第二个会话窗口产生了比较小的 CLS 分数。如果取它们的平均值来当做 CLS 分数，则根本看不出来页面的运行状况。原来页面是早期偏移多，后期偏移少，现在的平均值无法反映出这种情况。</p><h5 id="取所有会话窗口中的最大值" tabindex="-1">取所有会话窗口中的最大值 <a class="header-anchor" href="#取所有会话窗口中的最大值" aria-hidden="true">#</a></h5><p>这种方式是目前最优的计算方式，每次只取所有会话窗口的最大值，用来反映页面布局偏移的最差情况。详情请看 <a href="https://web.dev/evolving-cls/" target="_blank" rel="noopener noreferrer">Evolving the CLS metric</a>。</p><p>下面是第三种计算方式的测量代码：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">let</span> sessionValue <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> sessionEntries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> cls <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;layout-shift&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;layout-shift&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;performance&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Only count layout shifts without recent user input.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>hadRecentInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> firstSessionEntry <span class="token operator">=</span> sessionEntries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">const</span> lastSessionEntry <span class="token operator">=</span> sessionEntries<span class="token punctuation">[</span>sessionEntries<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>

            <span class="token comment">// If the entry occurred less than 1 second after the previous entry and</span>
            <span class="token comment">// less than 5 seconds after the first entry in the session, include the</span>
            <span class="token comment">// entry in the current session. Otherwise, start a new session.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                sessionValue
                <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>startTime <span class="token operator">-</span> lastSessionEntry<span class="token punctuation">.</span>startTime <span class="token operator">&lt;</span> <span class="token number">1000</span>
                <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>startTime <span class="token operator">-</span> firstSessionEntry<span class="token punctuation">.</span>startTime <span class="token operator">&lt;</span> <span class="token number">5000</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sessionValue <span class="token operator">+=</span> entry<span class="token punctuation">.</span>value
                sessionEntries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">formatCLSEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                sessionValue <span class="token operator">=</span> entry<span class="token punctuation">.</span>value
                sessionEntries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">formatCLSEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If the current session value is larger than the current CLS value,</span>
            <span class="token comment">// update CLS and the entries contributing to it.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionValue <span class="token operator">&gt;</span> cls<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cls<span class="token punctuation">.</span>value <span class="token operator">=</span> sessionValue
                cls<span class="token punctuation">.</span>entries <span class="token operator">=</span> sessionEntries
                cls<span class="token punctuation">.</span>startTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token function">deepCopy</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;layout-shift&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>output</p><div class="language-js line-numbers-mode"><pre><code><span class="token punctuation">{</span>
  <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">entryType</span><span class="token operator">:</span> <span class="token string">&quot;layout-shift&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">hadRecentInput</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastInputTime</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">sources</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>LayoutShiftAttribution<span class="token punctuation">,</span> LayoutShiftAttribution<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">startTime</span><span class="token operator">:</span> <span class="token number">1176.199999999255</span><span class="token punctuation">,</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0.000005752046026677329</span><span class="token punctuation">,</span> <span class="token comment">// CLS</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="domcontentloaded、load-事件" tabindex="-1">DOMContentLoaded、load 事件 <a class="header-anchor" href="#domcontentloaded、load-事件" aria-hidden="true">#</a></h4><p>当纯 HTML 被完全加载以及解析时，DOMContentLoaded 事件会被触发，不用等待 css、img、iframe 加载完。</p><p>当整个页面及所有依赖资源如样式表和图片都已完成加载时，将触发 load 事件。 虽然这两个性能指标比较旧了，但是它们仍然能反映页面的一些情况。对于它们进行监听仍然是必要的。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> lazyReportCache <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../utils/report&#39;</span>

<span class="token punctuation">[</span><span class="token string">&#39;load&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DOMContentLoaded&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;performance&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> type<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="首屏渲染时间" tabindex="-1">首屏渲染时间 <a class="header-anchor" href="#首屏渲染时间" aria-hidden="true">#</a></h4><p>大多数情况下，首屏渲染时间可以通过 load 事件获取。除了一些特殊情况，例如异步加载的图片和 DOM。</p><div class="language-js line-numbers-mode"><pre><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            &lt;div&gt;
                &lt;!-- 省略一堆代码... --&gt;
            &lt;/div&gt;
        </span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>像这种情况就无法通过 load 事件获取首屏渲染时间了。这时我们需要通过 MutationObserver 来获取首屏渲染时间。MutationObserver 在监听的 DOM 元素属性发生变化时会触发事件。</p><p>首屏渲染时间计算过程：</p><ul><li>1.利用 MutationObserver 监听 document 对象，每当 DOM 元素属性发生变更时，触发事件。</li><li>2.判断该 DOM 元素是否在首屏内，如果在，则在 requestAnimationFrame() 回调函数中调用 performance.now() 获取当前时间，作为它的绘制时间。</li><li>3.将最后一个 DOM 元素的绘制时间和首屏中所有加载的图片时间作对比，将最大值作为首屏渲染时间。</li></ul><h5 id="监听-dom" tabindex="-1">监听 Dom <a class="header-anchor" href="#监听-dom" aria-hidden="true">#</a></h5><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> next <span class="token operator">=</span> window<span class="token punctuation">.</span>requestAnimationFrame <span class="token operator">?</span> requestAnimationFrame <span class="token operator">:</span> setTimeout
<span class="token keyword">const</span> ignoreDOMList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;STYLE&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;SCRIPT&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;LINK&#39;</span><span class="token punctuation">]</span>
    
observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token parameter">mutationList</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mutation <span class="token keyword">of</span> mutationList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>addedNodes<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token function">isInScreen</span><span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        entries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            entry<span class="token punctuation">.</span>startTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">childList</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">subtree</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>上面的代码就是监听 DOM 变化的代码，同时需要过滤掉 style、script、link 等标签。</p><h5 id="判断是否在首屏" tabindex="-1">判断是否在首屏 <a class="header-anchor" href="#判断是否在首屏" aria-hidden="true">#</a></h5><p>一个页面的内容可能非常多，但用户最多只能看见一屏幕的内容。所以在统计首屏渲染时间的时候，需要限定范围，把渲染内容限定在当前屏幕内。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> viewportWidth <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth
<span class="token keyword">const</span> viewportHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight

<span class="token comment">// dom 对象是否在屏幕内</span>
<span class="token keyword">function</span> <span class="token function">isInScreen</span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rectInfo <span class="token operator">=</span> dom<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rectInfo<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> viewportWidth <span class="token operator">&amp;&amp;</span> rectInfo<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> viewportHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h5 id="使用-requestanimationframe-获取-dom-绘制时间" tabindex="-1">使用 requestAnimationFrame() 获取 DOM 绘制时间 <a class="header-anchor" href="#使用-requestanimationframe-获取-dom-绘制时间" aria-hidden="true">#</a></h5><p>当 DOM 变更触发 MutationObserver 事件时，只是代表 DOM 内容可以被读取到，并不代表该 DOM 被绘制到了屏幕上。</p><p><img src="/assets/ecbbae70f2c2fa52507f7315580144d0198402018f5a209f4af8e03277e114bc.ecbbae70.png" alt="picture 13"></p><p>从上图可以看出，当触发 MutationObserver 事件时，可以读取到 document.body 上已经有内容了，但实际上左边的屏幕并没有绘制任何内容。所以要调用 requestAnimationFrame() 在浏览器绘制成功后再获取当前时间作为 DOM 绘制时间。</p><h5 id="和首屏内的所有图片加载时间作对比" tabindex="-1">和首屏内的所有图片加载时间作对比 <a class="header-anchor" href="#和首屏内的所有图片加载时间作对比" aria-hidden="true">#</a></h5><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">getRenderTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token number">0</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">entry</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>startTime <span class="token operator">&gt;</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            startTime <span class="token operator">=</span> entry<span class="token punctuation">.</span>startTime
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 需要和当前页面所有加载图片的时间做对比，取最大值</span>
    <span class="token comment">// 图片请求时间要小于 startTime，响应结束时间要大于 startTime</span>
    performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">&#39;resource&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
            item<span class="token punctuation">.</span>initiatorType <span class="token operator">===</span> <span class="token string">&#39;img&#39;</span>
            <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>fetchStart <span class="token operator">&lt;</span> startTime 
            <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>responseEnd <span class="token operator">&gt;</span> startTime
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            startTime <span class="token operator">=</span> item<span class="token punctuation">.</span>responseEnd
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> startTime
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h5 id="优化" tabindex="-1">优化 <a class="header-anchor" href="#优化" aria-hidden="true">#</a></h5><p>现在的代码还没优化完，主要有两点注意事项：</p><ul><li>什么时候上报渲染时间？</li><li>如果兼容异步添加 DOM 的情况？</li></ul><p>第一点，必须要在 DOM 不再变化后再上报渲染时间，一般 load 事件触发后，DOM 就不再变化了。所以我们可以在这个时间点进行上报。 第二点，可以在 LCP 事件触发后再进行上报。不管是同步还是异步加载的 DOM，它都需要进行绘制，所以可以监听 LCP 事件，在该事件触发后才允许进行上报。 将以上两点方案结合在一起，就有了以下代码：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">let</span> isOnLoaded <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token function">executeAfterLoad</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    isOnLoaded <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> timer
<span class="token keyword">let</span> observer
<span class="token keyword">function</span> <span class="token function">checkDOMChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 等 load、lcp 事件触发后并且 DOM 树不再变化时，计算首屏渲染时间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isOnLoaded <span class="token operator">&amp;&amp;</span> <span class="token function">isLCPDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            observer <span class="token operator">&amp;&amp;</span> observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;performance&#39;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;first-screen-paint&#39;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">startTime</span><span class="token operator">:</span> <span class="token function">getRenderTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            entries <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">checkDOMChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>checkDOMChange() 代码每次在触发 MutationObserver 事件时进行调用，需要用防抖函数进行处理。</p><h4 id="接口请求耗时" tabindex="-1">接口请求耗时 <a class="header-anchor" href="#接口请求耗时" aria-hidden="true">#</a></h4><p>接口请求耗时需要对 XMLHttpRequest 和 fetch 进行监听。</p><h5 id="监听-xmlhttprequest" tabindex="-1">监听 XMLHttpRequest <a class="header-anchor" href="#监听-xmlhttprequest" aria-hidden="true">#</a></h5><div class="language-js line-numbers-mode"><pre><code>originalProto<span class="token punctuation">.</span><span class="token function-variable function">open</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">newOpen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token function">originalOpen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

originalProto<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">newSend</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token function-variable function">onLoadend</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endTime <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startTime

        <span class="token keyword">const</span> <span class="token punctuation">{</span> status<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> url<span class="token punctuation">,</span> method <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">const</span> reportData <span class="token operator">=</span> <span class="token punctuation">{</span>
            status<span class="token punctuation">,</span>
            duration<span class="token punctuation">,</span>
            startTime<span class="token punctuation">,</span>
            endTime<span class="token punctuation">,</span>
            url<span class="token punctuation">,</span>
            <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token punctuation">(</span>method <span class="token operator">||</span> <span class="token string">&#39;GET&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">success</span><span class="token operator">:</span> status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;xhr&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;performance&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span>reportData<span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;loadend&#39;</span><span class="token punctuation">,</span> onLoadend<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;loadend&#39;</span><span class="token punctuation">,</span> onLoadend<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">originalSend</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>如何判断 XML 请求是否成功？可以根据他的状态码是否在 200~299 之间。如果在，那就是成功，否则失败。</p><h5 id="监听-fetch" tabindex="-1">监听 fetch <a class="header-anchor" href="#监听-fetch" aria-hidden="true">#</a></h5><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> originalFetch <span class="token operator">=</span> window<span class="token punctuation">.</span>fetch

<span class="token keyword">function</span> <span class="token function">overwriteFetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">fetch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">newFetch</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> reportData <span class="token operator">=</span> <span class="token punctuation">{</span>
            startTime<span class="token punctuation">,</span>
            url<span class="token punctuation">,</span>
            <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token punctuation">(</span>config<span class="token operator">?.</span>method <span class="token operator">||</span> <span class="token string">&#39;GET&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;fetch&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;performance&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">originalFetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            reportData<span class="token punctuation">.</span>endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            reportData<span class="token punctuation">.</span>duration <span class="token operator">=</span> reportData<span class="token punctuation">.</span>endTime <span class="token operator">-</span> reportData<span class="token punctuation">.</span>startTime

            <span class="token keyword">const</span> data <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            reportData<span class="token punctuation">.</span>status <span class="token operator">=</span> data<span class="token punctuation">.</span>status
            reportData<span class="token punctuation">.</span>success <span class="token operator">=</span> data<span class="token punctuation">.</span>ok

            <span class="token function">lazyReportCache</span><span class="token punctuation">(</span>reportData<span class="token punctuation">)</span>

            <span class="token keyword">return</span> res
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            reportData<span class="token punctuation">.</span>endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            reportData<span class="token punctuation">.</span>duration <span class="token operator">=</span> reportData<span class="token punctuation">.</span>endTime <span class="token operator">-</span> reportData<span class="token punctuation">.</span>startTime
            reportData<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">0</span>
            reportData<span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token boolean">false</span>

            <span class="token function">lazyReportCache</span><span class="token punctuation">(</span>reportData<span class="token punctuation">)</span>

            <span class="token keyword">throw</span> err
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>对于 fetch，可以根据返回数据中的的 ok 字段判断请求是否成功，如果为 true 则请求成功，否则失败。 注意，监听到的接口请求时间和 chrome devtool 上检测到的时间可能不一样。这是因为 chrome devtool 上检测到的是 HTTP 请求发送和接口整个过程的时间。但是 xhr 和 fetch 是异步请求，接口请求成功后需要调用回调函数。事件触发时会把回调函数放到消息队列，然后浏览器再处理，这中间也有一个等待过程。</p><h4 id="资源加载时间、缓存命中率" tabindex="-1">资源加载时间、缓存命中率 <a class="header-anchor" href="#资源加载时间、缓存命中率" aria-hidden="true">#</a></h4><p>通过 PerformanceObserver 可以监听 resource 和 navigation 事件，如果浏览器不支持 PerformanceObserver，还可以通过 performance.getEntriesByType(entryType) 来进行降级处理。 当 resource 事件触发时，可以获取到对应的资源列表，每个资源对象包含以下一些字段： <img src="/assets/67c62f16e7d459332299e875b88cf502dbf4b95dc6790c64fa97562176d01a41.67c62f16.png" alt="picture 14"></p><p>从这些字段中我们可以提取到一些有用的信息：</p><div class="language-js line-numbers-mode"><pre><code><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token comment">// 资源名称</span>
    <span class="token literal-property property">subType</span><span class="token operator">:</span> entryType<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;performance&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sourceType</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>initiatorType<span class="token punctuation">,</span> <span class="token comment">// 资源类型</span>
    <span class="token literal-property property">duration</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>duration<span class="token punctuation">,</span> <span class="token comment">// 资源加载耗时</span>
    <span class="token literal-property property">dns</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>domainLookupEnd <span class="token operator">-</span> entry<span class="token punctuation">.</span>domainLookupStart<span class="token punctuation">,</span> <span class="token comment">// DNS 耗时</span>
    <span class="token literal-property property">tcp</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> entry<span class="token punctuation">.</span>connectStart<span class="token punctuation">,</span> <span class="token comment">// 建立 tcp 连接耗时</span>
    <span class="token literal-property property">redirect</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> entry<span class="token punctuation">.</span>redirectStart<span class="token punctuation">,</span> <span class="token comment">// 重定向耗时</span>
    <span class="token literal-property property">ttfb</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>responseStart<span class="token punctuation">,</span> <span class="token comment">// 首字节时间</span>
    <span class="token literal-property property">protocol</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>nextHopProtocol<span class="token punctuation">,</span> <span class="token comment">// 请求协议</span>
    <span class="token literal-property property">responseBodySize</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>encodedBodySize<span class="token punctuation">,</span> <span class="token comment">// 响应内容大小</span>
    <span class="token literal-property property">responseHeaderSize</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>transferSize <span class="token operator">-</span> entry<span class="token punctuation">.</span>encodedBodySize<span class="token punctuation">,</span> <span class="token comment">// 响应头部大小</span>
    <span class="token literal-property property">resourceSize</span><span class="token operator">:</span> entry<span class="token punctuation">.</span>decodedBodySize<span class="token punctuation">,</span> <span class="token comment">// 资源解压后的大小</span>
    <span class="token literal-property property">isCache</span><span class="token operator">:</span> <span class="token function">isCache</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 是否命中缓存</span>
    <span class="token literal-property property">startTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h5 id="判断该资源是否命中缓存" tabindex="-1">判断该资源是否命中缓存 <a class="header-anchor" href="#判断该资源是否命中缓存" aria-hidden="true">#</a></h5><p>在这些资源对象中有一个 transferSize 字段，它表示获取资源的大小，包括响应头字段和响应数据的大小。如果这个值为 0，说明是从缓存中直接读取的（强制缓存）。如果这个值不为 0，但是 encodedBodySize 字段为 0，说明它走的是协商缓存（encodedBodySize 表示请求响应数据 body 的大小）。</p><div class="language-JS line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">isCache</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接从缓存读取或 304</span>
    <span class="token keyword">return</span> entry<span class="token punctuation">.</span>transferSize <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>transferSize <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>encodedBodySize <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>不符合以上条件的，说明未命中缓存。然后将所有命中缓存的数据/总数据就能得出缓存命中率。</p><h4 id="浏览器往返缓存-bfc（back-forward-cache）" tabindex="-1">浏览器往返缓存 BFC（back/forward cache） <a class="header-anchor" href="#浏览器往返缓存-bfc（back-forward-cache）" aria-hidden="true">#</a></h4><p>bfcache 是一种内存缓存，它会将整个页面保存在内存中。当用户返回时可以马上看到整个页面，而不用再次刷新。据该文章 bfcache 介绍，firfox 和 safari 一直支持 bfc，chrome 只有在高版本的移动端浏览器支持。但我试了一下，只有 safari 浏览器支持，可能我的 firfox 版本不对。 但是 bfc 也是有缺点的，当用户返回并从 bfc 中恢复页面时，原来页面的代码不会再次执行。为此，浏览器提供了一个 pageshow 事件，可以把需要再次执行的代码放在里面。</p><div class="language-JS line-numbers-mode"><pre><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pageshow&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果该属性为 true，表示是从 bfc 中恢复的页面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>persisted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;This page was restored from the bfcache.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;This page was loaded normally.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="fps" tabindex="-1">FPS <a class="header-anchor" href="#fps" aria-hidden="true">#</a></h4><p>利用 requestAnimationFrame() 我们可以计算当前页面的 FPS。</p><div class="language-JS line-numbers-mode"><pre><code><span class="token keyword">const</span> next <span class="token operator">=</span> window<span class="token punctuation">.</span>requestAnimationFrame 
    <span class="token operator">?</span> <span class="token function-variable function">requestAnimationFrame</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">const</span> frames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">fps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> frame <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> lastSecond <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">calculateFPS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        frame<span class="token operator">++</span>
        <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastSecond <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">&lt;=</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 由于 now - lastSecond 的单位是毫秒，所以 frame 要 * 1000</span>
            <span class="token keyword">const</span> fps <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>frame <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> lastSecond<span class="token punctuation">)</span><span class="token punctuation">)</span>
            frames<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fps<span class="token punctuation">)</span>
                
            frame <span class="token operator">=</span> <span class="token number">0</span>
            lastSecond <span class="token operator">=</span> now
        <span class="token punctuation">}</span>
    
        <span class="token comment">// 避免上报太快，缓存一定数量再上报</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frames<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">report</span><span class="token punctuation">(</span><span class="token function">deepCopy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                frames<span class="token punctuation">,</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;performace&#39;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;fps&#39;</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
            frames<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>

        <span class="token function">next</span><span class="token punctuation">(</span>calculateFPS<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">calculateFPS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>代码逻辑如下： 1.先记录一个初始时间，然后每次触发 requestAnimationFrame() 时，就将帧数加 1。过去一秒后用帧数/流逝的时间就能得到当前帧率。 当连续三个低于 20 的 FPS 出现时，我们可以断定页面出现了卡顿，详情请看 <a href="https://zhuanlan.zhihu.com/p/39292837" target="_blank" rel="noopener noreferrer">如何监控网页的卡顿</a>。</p><div class="language-JS line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isBlocking</span><span class="token punctuation">(</span><span class="token parameter">fpsList<span class="token punctuation">,</span> below <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> last <span class="token operator">=</span> <span class="token number">3</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fpsList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fpsList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> fpsList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> below<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            count <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;=</span> last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="vue-路由变更渲染时间" tabindex="-1">Vue 路由变更渲染时间 <a class="header-anchor" href="#vue-路由变更渲染时间" aria-hidden="true">#</a></h4><p>首屏渲染时间我们已经知道如何计算了，但是如何计算 SPA 应用的页面路由切换导致的页面渲染时间呢？本文用 Vue 作为示例，讲一下我的思路。</p><div class="language-JS line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">onVueRouter</span><span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> isFirst <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">let</span> startTime
    router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首次进入页面已经有其他统计的渲染时间可用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isFirst <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 给 router 新增一个字段，表示是否要计算渲染时间</span>
        <span class="token comment">// 只有路由跳转才需要计算</span>
        router<span class="token punctuation">.</span>needCalculateRenderTime <span class="token operator">=</span> <span class="token boolean">true</span>
        startTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> timer
    Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>router<span class="token punctuation">.</span>needCalculateRenderTime<span class="token punctuation">)</span> <span class="token keyword">return</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 仅在整个视图都被渲染之后才会运行的代码</span>
                <span class="token keyword">const</span> now <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>

                timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    router<span class="token punctuation">.</span>needCalculateRenderTime <span class="token operator">=</span> <span class="token boolean">false</span>
                    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;performance&#39;</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;vue-router-change-paint&#39;</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">duration</span><span class="token operator">:</span> now <span class="token operator">-</span> startTime<span class="token punctuation">,</span>
                        <span class="token literal-property property">startTime</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
                        <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>代码逻辑如下：</p><ul><li>监听路由钩子，在路由切换时会触发 router.beforeEach() 钩子，在该钩子的回调函数里将当前时间记为渲染开始时间。</li><li>利用 Vue.mixin() 对所有组件的 mounted() 注入一个函数。每个函数都执行一个防抖函数。</li><li>当最后一个组件的 mounted() 触发时，就代表该路由下的所有组件已经挂载完毕。可以在 this.$nextTick() 回调函数中获取渲染时间。</li></ul><p>同时，还要考虑到一个情况。不切换路由时，也会有变更组件的情况，这时不应该在这些组件的 mounted() 里进行渲染时间计算。所以需要添加一个 needCalculateRenderTime 字段，当切换路由时将它设为 true，代表可以计算渲染时间了。</p><h3 id="错误数据采集" tabindex="-1">错误数据采集 <a class="header-anchor" href="#错误数据采集" aria-hidden="true">#</a></h3><h4 id="资源加载错误" tabindex="-1">资源加载错误 <a class="header-anchor" href="#资源加载错误" aria-hidden="true">#</a></h4><p>使用 addEventListener() 监听 error 事件，可以捕获到资源加载失败错误。</p><div class="language-JS line-numbers-mode"><pre><code><span class="token comment">// 捕获资源加载失败错误 js css img...</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target<span class="token punctuation">)</span> <span class="token keyword">return</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href
        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;resource&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> e<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>
            <span class="token literal-property property">html</span><span class="token operator">:</span> target<span class="token punctuation">.</span>outerHTML<span class="token punctuation">,</span>
            <span class="token literal-property property">resourceType</span><span class="token operator">:</span> target<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span>
            <span class="token literal-property property">paths</span><span class="token operator">:</span> e<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="js-错误" tabindex="-1">js 错误 <a class="header-anchor" href="#js-错误" aria-hidden="true">#</a></h4><p>使用 window.onerror 可以监听 js 错误。</p><div class="language-JS line-numbers-mode"><pre><code><span class="token comment">// 监听 js 错误</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> line<span class="token punctuation">,</span> column<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        msg<span class="token punctuation">,</span>
        line<span class="token punctuation">,</span>
        column<span class="token punctuation">,</span>
        <span class="token literal-property property">error</span><span class="token operator">:</span> error<span class="token punctuation">.</span>stack<span class="token punctuation">,</span>
        <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;js&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">pageURL</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">startTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="promise-错误" tabindex="-1">promise 错误 <a class="header-anchor" href="#promise-错误" aria-hidden="true">#</a></h4><p>使用 addEventListener() 监听 unhandledrejection 事件，可以捕获到未处理的 promise 错误。</p><div class="language-JS line-numbers-mode"><pre><code><span class="token comment">// 监听 promise 错误 缺点是获取不到列数据</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;unhandledrejection&#39;</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">reason</span><span class="token operator">:</span> e<span class="token punctuation">.</span>reason<span class="token operator">?.</span>stack<span class="token punctuation">,</span>
        <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;promise&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">startTime</span><span class="token operator">:</span> e<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>
        <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="sourcemap" tabindex="-1">sourcemap <a class="header-anchor" href="#sourcemap" aria-hidden="true">#</a></h4><p>一般生产环境的代码都是经过压缩的，并且生产环境不会把 sourcemap 文件上传。所以生产环境上的代码报错信息是很难读的。因此，我们可以利用 source-map 来对这些压缩过的代码报错信息进行还原。 当代码报错时，我们可以获取到对应的文件名、行数、列数:</p><div class="language-JS line-numbers-mode"><pre><code><span class="token punctuation">{</span>
    <span class="token literal-property property">line</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">column</span><span class="token operator">:</span> <span class="token number">17</span><span class="token punctuation">,</span>
    <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">&#39;https:/www.xxx.com/bundlejs&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后调用下面的代码进行还原：</p><div class="language-JS line-numbers-mode"><pre><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mapObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">getMapFileContent</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">sourceMap<span class="token punctuation">.</span>SourceMapConsumer</span><span class="token punctuation">(</span>mapObj<span class="token punctuation">)</span>
    <span class="token comment">// 将 webpack://source-map-demo/./src/index.js 文件中的 ./ 去掉</span>
    <span class="token keyword">const</span> sources <span class="token operator">=</span> mapObj<span class="token punctuation">.</span>sources<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token function">format</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 根据压缩后的报错信息得出未压缩前的报错行列数和源码文件</span>
    <span class="token keyword">const</span> originalInfo <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">originalPositionFor</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">line</span><span class="token operator">:</span> error<span class="token punctuation">.</span>line<span class="token punctuation">,</span> <span class="token literal-property property">column</span><span class="token operator">:</span> error<span class="token punctuation">.</span>column <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// sourcesContent 中包含了各个文件的未压缩前的源码，根据文件名找出对应的源码</span>
    <span class="token keyword">const</span> originalFileContent <span class="token operator">=</span> mapObj<span class="token punctuation">.</span>sourcesContent<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>originalInfo<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">file</span><span class="token operator">:</span> originalInfo<span class="token punctuation">.</span>source<span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> originalFileContent<span class="token punctuation">,</span>
        <span class="token literal-property property">line</span><span class="token operator">:</span> originalInfo<span class="token punctuation">.</span>line<span class="token punctuation">,</span>
        <span class="token literal-property property">column</span><span class="token operator">:</span> originalInfo<span class="token punctuation">.</span>column<span class="token punctuation">,</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">,</span>
        <span class="token literal-property property">error</span><span class="token operator">:</span> error<span class="token punctuation">.</span>error
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> item<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\.\/)*</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getMapFileContent</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./maps/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.map</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>每次项目打包时，如果开启了 sourcemap，那么每一个 js 文件都会有一个对应的 map 文件。</p><div class="language-"><pre><code>bundle.js
bundle.js.map
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这时 js 文件放在静态服务器上供用户访问，map 文件存储在服务器，用于还原错误信息。source-map 库可以根据压缩过的代码报错信息还原出未压缩前的代码报错信息。例如压缩后报错位置为 1 行 47 列，还原后真正的位置可能为 4 行 10 列。除了位置信息，还可以获取到源码原文。</p><p><img src="/assets/5bae280f756bfe048503ee310385f331a0140e4bc5babbbdea211ba327bbbc97.5bae280f.png" alt="picture 15"><br> 上图就是一个代码报错还原后的示例。鉴于这部分内容不属于 SDK 的范围，所以我另开了一个 仓库 来做这个事，有兴趣可以看看。</p><h4 id="vue-错误" tabindex="-1">Vue 错误 <a class="header-anchor" href="#vue-错误" aria-hidden="true">#</a></h4><p>利用 window.onerror 是捕获不到 Vue 错误的，它需要使用 Vue 提供的 API 进行监听。</p><div class="language-JS line-numbers-mode"><pre><code>Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将报错信息打印到控制台</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        info<span class="token punctuation">,</span>
        <span class="token literal-property property">error</span><span class="token operator">:</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">,</span>
        <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;vue&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">startTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="行为数据采集" tabindex="-1">行为数据采集 <a class="header-anchor" href="#行为数据采集" aria-hidden="true">#</a></h3><h4 id="pv、uv" tabindex="-1">PV、UV <a class="header-anchor" href="#pv、uv" aria-hidden="true">#</a></h4><p>PV(page view) 是页面浏览量，UV(Unique visitor)用户访问量。PV 只要访问一次页面就算一次，UV 同一天内多次访问只算一次。 对于前端来说，只要每次进入页面上报一次 PV 就行，UV 的统计放在服务端来做，主要是分析上报的数据来统计得出 UV。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">pv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;behavior&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;pv&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">startTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">referrer</span><span class="token operator">:</span> document<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span>
        <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="页面停留时长" tabindex="-1">页面停留时长 <a class="header-anchor" href="#页面停留时长" aria-hidden="true">#</a></h4><p>用户进入页面记录一个初始时间，用户离开页面时用当前时间减去初始时间，就是用户停留时长。这个计算逻辑可以放在 beforeunload 事件里做。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">pageAccessDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onBeforeunload</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;behavior&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;page-access-duration&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="页面访问深度" tabindex="-1">页面访问深度 <a class="header-anchor" href="#页面访问深度" aria-hidden="true">#</a></h4><p>记录页面访问深度是很有用的，例如不同的活动页面 a 和 b。a 平均访问深度只有 50%，b 平均访问深度有 80%，说明 b 更受用户喜欢，根据这一点可以有针对性的修改 a 活动页面。</p><p>除此之外还可以利用访问深度以及停留时长来鉴别电商刷单。例如有人进来页面后一下就把页面拉到底部然后等待一段时间后购买，有人是慢慢的往下滚动页面，最后再购买。虽然他们在页面的停留时间一样，但明显第一个人更像是刷单的。</p><p>页面访问深度计算过程稍微复杂一点：</p><ul><li>1.用户进入页面时，记录当前时间、scrollTop 值、页面可视高度、页面总高度。</li><li>2.用户滚动页面的那一刻，会触发 scroll 事件，在回调函数中用第一点得到的数据算出页面访问深度和停留时长。</li><li>3.当用户滚动页面到某一点时，停下继续观看页面。这时记录当前时间、scrollTop 值、页面可视高度、页面总高度。</li><li>4.重复第二点...</li></ul><p>具体代码请看：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">let</span> timer
<span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> hasReport <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> pageHeight <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> scrollTop <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> viewportHeight <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">pageAccessHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;scroll&#39;</span><span class="token punctuation">,</span> onScroll<span class="token punctuation">)</span>

    <span class="token function">onBeforeunload</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> now <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
            <span class="token literal-property property">duration</span><span class="token operator">:</span> now <span class="token operator">-</span> startTime<span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;behavior&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;page-access-height&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">toPercent</span><span class="token punctuation">(</span><span class="token punctuation">(</span>scrollTop <span class="token operator">+</span> viewportHeight<span class="token punctuation">)</span> <span class="token operator">/</span> pageHeight<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 页面加载完成后初始化记录当前访问高度、时间</span>
    <span class="token function">executeAfterLoad</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        startTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        pageHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight
        scrollTop <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop
        viewportHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">onScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    <span class="token keyword">const</span> now <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasReport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasReport <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
            <span class="token literal-property property">duration</span><span class="token operator">:</span> now <span class="token operator">-</span> startTime<span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;behavior&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;page-access-height&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">toPercent</span><span class="token punctuation">(</span><span class="token punctuation">(</span>scrollTop <span class="token operator">+</span> viewportHeight<span class="token punctuation">)</span> <span class="token operator">/</span> pageHeight<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        hasReport <span class="token operator">=</span> <span class="token boolean">false</span>
        startTime <span class="token operator">=</span> now
        pageHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight
        scrollTop <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop
        viewportHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight        
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">toPercent</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&#39;100%&#39;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>val <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;%&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h4 id="用户点击" tabindex="-1">用户点击 <a class="header-anchor" href="#用户点击" aria-hidden="true">#</a></h4><p>利用 addEventListener() 监听 mousedown、touchstart 事件，我们可以收集用户每一次点击区域的大小，点击坐标在整个页面中的具体位置，点击元素的内容等信息。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token string">&#39;mousedown&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;touchstart&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">eventType</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> timer
        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
            timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> target <span class="token operator">=</span> event<span class="token punctuation">.</span>target
                <span class="token keyword">const</span> <span class="token punctuation">{</span> top<span class="token punctuation">,</span> left <span class="token punctuation">}</span> <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                
                <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    top<span class="token punctuation">,</span>
                    left<span class="token punctuation">,</span>
                    eventType<span class="token punctuation">,</span>
                    <span class="token literal-property property">pageHeight</span><span class="token operator">:</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">,</span>
                    <span class="token literal-property property">scrollTop</span><span class="token operator">:</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop<span class="token punctuation">,</span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;behavior&#39;</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">target</span><span class="token operator">:</span> target<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span>
                    <span class="token literal-property property">paths</span><span class="token operator">:</span> event<span class="token punctuation">.</span>path<span class="token operator">?.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">startTime</span><span class="token operator">:</span> event<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>
                    <span class="token literal-property property">pageURL</span><span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">outerHTML</span><span class="token operator">:</span> target<span class="token punctuation">.</span>outerHTML<span class="token punctuation">,</span>
                    <span class="token literal-property property">innerHTML</span><span class="token operator">:</span> target<span class="token punctuation">.</span>innerHTML<span class="token punctuation">,</span>
                    <span class="token literal-property property">width</span><span class="token operator">:</span> target<span class="token punctuation">.</span>offsetWidth<span class="token punctuation">,</span>
                    <span class="token literal-property property">height</span><span class="token operator">:</span> target<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">,</span>
                    <span class="token literal-property property">viewport</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">width</span><span class="token operator">:</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span>
                        <span class="token literal-property property">height</span><span class="token operator">:</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="页面跳转" tabindex="-1">页面跳转 <a class="header-anchor" href="#页面跳转" aria-hidden="true">#</a></h4><p>利用 addEventListener() 监听 popstate、hashchange 页面跳转事件。需要注意的是调用history.pushState()或history.replaceState()不会触发popstate事件。只有在做出浏览器动作时，才会触发该事件，如用户点击浏览器的回退按钮（或者在Javascript代码中调用history.back()或者history.forward()方法）。同理，hashchange 也一样。</p><div class="language-JS line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">pageChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> from <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;popstate&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> to <span class="token operator">=</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            from<span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;behavior&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;popstate&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        from <span class="token operator">=</span> to
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> oldURL <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;hashchange&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newURL <span class="token operator">=</span> event<span class="token punctuation">.</span>newURL

        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">from</span><span class="token operator">:</span> oldURL<span class="token punctuation">,</span>
            <span class="token literal-property property">to</span><span class="token operator">:</span> newURL<span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;behavior&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token string">&#39;hashchange&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        oldURL <span class="token operator">=</span> newURL
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="vue-路由变更" tabindex="-1">Vue 路由变更 <a class="header-anchor" href="#vue-路由变更" aria-hidden="true">#</a></h4><p>Vue 可以利用 router.beforeEach 钩子进行路由变更的监听。</p><div class="language-JS line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">onVueRouter</span><span class="token punctuation">(</span><span class="token parameter">router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首次加载页面不用统计</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>from<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">params</span><span class="token operator">:</span> to<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
            <span class="token literal-property property">query</span><span class="token operator">:</span> to<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            data<span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> to<span class="token punctuation">.</span>name <span class="token operator">||</span> to<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;behavior&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subType</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;vue-router-change&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pv&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">from</span><span class="token operator">:</span> from<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
            <span class="token literal-property property">to</span><span class="token operator">:</span> to<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
            <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="数据上报" tabindex="-1">数据上报 <a class="header-anchor" href="#数据上报" aria-hidden="true">#</a></h3><h4 id="上报方法" tabindex="-1">上报方法 <a class="header-anchor" href="#上报方法" aria-hidden="true">#</a></h4><p>数据上报可以使用以下几种方式：</p><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon" target="_blank" rel="noopener noreferrer">sendBeacon</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" target="_blank" rel="noopener noreferrer">XMLHttpRequest</a></li><li>image</li></ul><blockquote><p>使用 sendBeacon() 方法会使用户代理在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能。这就解决了提交分析数据时的所有的问题：数据可靠，传输异步并且不会影响下一页面的加载。</p></blockquote><p>在不支持 sendBeacon 的浏览器下我们可以使用 XMLHttpRequest 来进行上报。一个 HTTP 请求包含发送和接收两个步骤。其实对于上报来说，我们只要确保能发出去就可以了。也就是发送成功了就行，接不接收响应无所谓。为此，我做了个实验，在 beforeunload 用 XMLHttpRequest 传送了 30kb 的数据（一般的待上报数据很少会有这么大），换了不同的浏览器，都可以成功发出去。当然，这和硬件性能、网络状态也是有关联的。</p><h4 id="上报时机" tabindex="-1">上报时机 <a class="header-anchor" href="#上报时机" aria-hidden="true">#</a></h4><p>上报时机有三种：</p><ul><li>采用 requestIdleCallback/setTimeout 延时上报。</li><li>在 beforeunload 回调函数里上报。</li><li>缓存上报数据，达到一定数量后再上报。</li></ul><p>建议将三种方式结合一起上报：</p><ul><li>先缓存上报数据，缓存到一定数量后，利用 requestIdleCallback/setTimeout 延时上报。</li><li>在页面离开时统一将未上报的数据进行上报。</li></ul><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h3><h3 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-hidden="true">#</a></h3><h2 id="数据整理和存储" tabindex="-1">数据整理和存储 <a class="header-anchor" href="#数据整理和存储" aria-hidden="true">#</a></h2><h2 id="数据展示" tabindex="-1">数据展示 <a class="header-anchor" href="#数据展示" aria-hidden="true">#</a></h2></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><!----></div></div><div class="updated" data-v-fb8d84c6><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"base_angular_index.md\":\"b7fb98d8\",\"base_aot_aot.md\":\"c43520f0\",\"base_babel_advanced.md\":\"63d342bd\",\"base_babel_babel.md\":\"08db37cd\",\"base_babel_index.md\":\"7eeed92e\",\"base_c_index.md\":\"b4d74b36\",\"base_centos_index.md\":\"a9a38139\",\"base_chrome.google_chrome.md\":\"9ab68b28\",\"base_chrome_chrome.md\":\"d5478063\",\"base_css_css.md\":\"53cfe2c2\",\"base_docker_index.md\":\"ce74c680\",\"base_eclipse_index.md\":\"237a2a6a\",\"base_element_index.md\":\"89357051\",\"base_eslint_ellint.md\":\"ed5245f3\",\"base_git_git.md\":\"94bdb8c9\",\"base_git_index.md\":\"0703fa56\",\"base_gitee_gitee.md\":\"cab28a11\",\"base_index.md\":\"2c3d9022\",\"base_javascript_index.md\":\"763b15a0\",\"base_jenkins_index.md\":\"4f161285\",\"base_k8s_changelog.md\":\"b3602f66\",\"base_k8s_index.md\":\"7566b1e3\",\"base_lerna_index.md\":\"c101cd05\",\"base_linux_desktop-environment_desktop-environment.md\":\"e98166a4\",\"base_linux_distribution_fedora_fedora.md\":\"27cd3611\",\"base_linux_distribution_deepin_deepin.md\":\"6d619bd8\",\"base_linux_distribution_release-linux.md\":\"b9f41044\",\"base_linux_index.md\":\"3b9628c0\",\"base_linux_linux运维管理.md\":\"131c0685\",\"base_markdown_markdown.md\":\"d0c50375\",\"base_node_index.md\":\"82ac46bf\",\"base_node_package.json.md\":\"5dcd94a1\",\"base_npm_index.md\":\"77335796\",\"base_pnpm_index.md\":\"3720ecc2\",\"base_rancher_rancher_v1.x.md\":\"737d5024\",\"base_sprint_sprintboot_index.md\":\"a3803d2f\",\"base_typescript_typescript 2.md\":\"5c9d9fc7\",\"base_typescript_typescript.md\":\"2107d092\",\"base_v8_index.md\":\"ff3988a2\",\"base_vite_index.md\":\"8c652462\",\"base_vite_vite.md\":\"2a219f01\",\"base_vitepress_index.md\":\"1d84b7f6\",\"base_vscode_configuration.md\":\"0544a770\",\"base_vscode_devextension.md\":\"943eea8d\",\"base_vscode_index.md\":\"fd79141e\",\"base_vscode_index的副本.md\":\"c01426cf\",\"base_vscode_setting.vscode.wit.md\":\"e7d097ce\",\"base_vscode_vscode.md\":\"dbf5c04b\",\"base_vue_cli.md\":\"887006a7\",\"base_vue_compile 2.md\":\"abcbe179\",\"base_vue_compile.md\":\"3bc59f4f\",\"base_vue_composition-api-vue2.md\":\"e7ddbfa4\",\"base_vue_index 2.md\":\"7a06bd7b\",\"base_vue_index.md\":\"f58fe564\",\"base_vue_rule 2.md\":\"d05982e0\",\"base_vue_rule.md\":\"50c0dde7\",\"base_vue_vuecli_index.md\":\"f17a3bc1\",\"base_vuecli_index.md\":\"141ebc83\",\"base_wechat_index.md\":\"9feec7b6\",\"base_windows_window.md\":\"8a580416\",\"base_windows_windows.md\":\"5dbcbfed\",\"base_winget_index.md\":\"85597476\",\"base_winget_package.json.md\":\"494751ea\",\"base_yarn_index.md\":\"169d3711\",\"data_常用算法.md\":\"fb437b77\",\"data_数据结构.md\":\"f105a4dc\",\"data_算法题.md\":\"e7f551f0\",\"economics_daikuan.md\":\"5fbc18c8\",\"hardware_car_jeep_index.md\":\"d5c72757\",\"hardware_earphone_index.md\":\"2712d9ac\",\"hardware_index.md\":\"9a014f54\",\"hardware_ipad.md\":\"bd7dc48e\",\"hardware_keyboard_index.md\":\"5a8e9df6\",\"hardware_pc.md\":\"f80bac39\",\"hardware_phone.md\":\"1f8b0565\",\"hardware_人体工学椅.md\":\"3663023d\",\"hardware_接口.md\":\"1941bec4\",\"index.md\":\"129099ac\",\"movies_index.md\":\"4df168f8\",\"net_56_109.md\":\"a1402b78\",\"net_56_110.md\":\"11434ea4\",\"net_56_index.md\":\"7d8e261d\",\"net_netprotocal_http_index.md\":\"f374b289\",\"net_netprotocal_http2_index.md\":\"a743506a\",\"net_netprotocal_index.md\":\"29fe4819\",\"net_browser_index.md\":\"356857d9\",\"net_domains_index.md\":\"2b1ab77b\",\"net_gfw.md\":\"4ac408c0\",\"net_index 2.md\":\"03d74029\",\"net_index.md\":\"bf0e58ce\",\"net_监控_index.md\":\"c87f8a3c\",\"net_监控_前端监控 sdk 的一些技术要点原理分析.md\":\"94fb4204\",\"net_监控_前端监控平台系列：js sdk（已开源）.md\":\"994dd3cf\",\"net_监控_前端监控平台系列：服务端功能设计与实现.md\":\"ecf7f010\",\"net_网络协议_index.md\":\"d81eebe7\",\"net_路由器_路由器.md\":\"7b473456\",\"os_filesystem.md\":\"94224199\",\"os_cardos_index.md\":\"6a54979f\",\"os_kernel-windows.md\":\"95305664\",\"os_uos_index.md\":\"b24fb656\",\"os_windows_windows-kernel_filesystem-windows.md\":\"e781039b\",\"os_windows_windows-kernel_powershell.md\":\"087cf6fd\",\"os_windows_windows-kernel_tools-windows.md\":\"879becc1\",\"os_windows_windows-kernel_windows.md\":\"74542254\",\"os_windows_windows-kernel_垃圾清理.md\":\"a61d7f0f\",\"software_a-tools.md\":\"2d8b3a4d\",\"software_browser_index.md\":\"4c792ac1\",\"software_download-tools.md\":\"6b3fce1a\",\"software_index.md\":\"e824bbad\",\"software_news21-05.hardware.md\":\"92971134\",\"software_news21.software.md\":\"3f581dd7\",\"todos_index.md\":\"e0ca8b4d\",\"topic_bigdata_index.md\":\"853970c5\",\"topic_container_index.md\":\"c6882023\",\"topic_data-visualization_139_03.md\":\"9e00128a\",\"topic_data-visualization_139_04.md\":\"edf7c329\",\"topic_data-visualization_139_05.md\":\"dba3a698\",\"topic_data-visualization_139_06.md\":\"05c7bb98\",\"topic_data-visualization_139_index.md\":\"b190bfca\",\"topic_data-visualization_index.md\":\"8596728a\",\"topic_frontend_components_login.md\":\"1ff239d9\",\"topic_frontend_components_scrollbar_scrollbar.md\":\"fe6a3423\",\"topic_frontend_components_tree-select_index.md\":\"14f8be1f\",\"topic_frontend_index.md\":\"4165fd0f\",\"topic_frontend_portal_index.md\":\"cf51fc78\",\"topic_frontend_router_index.md\":\"2e57383b\",\"topic_frontend_router_router.md\":\"9eca97ed\",\"topic_frontend_template_template.md\":\"2beacd66\",\"topic_frontend_vscode_index.md\":\"86357607\",\"topic_frontend_数据埋点规范.md\":\"b85ad9fd\",\"topic_frontend_登录鉴权_index.md\":\"32a01b9a\",\"topic_frontend_跨端方案_index.md\":\"ae827069\",\"topic_index.md\":\"861e0c40\",\"topic_leader.md\":\"f3195180\",\"topic_license_license.md\":\"2f02a5af\",\"topic_manamge.md\":\"e983891f\",\"topic_materials-vue2_index.md\":\"b407d3d6\",\"topic_micro-soa_index.md\":\"e4d81f9b\",\"topic_programming-paradigm_programming-paradigm.md\":\"691bf1b6\",\"topic_tdd_index.md\":\"88a3a084\",\"topic_tree-shaking_index.md\":\"a8562cf8\",\"topic_webadmin_index.md\":\"e8e6b04f\",\"topic_哲学_国学.md\":\"0123d402\",\"topic_计算机编码_计算机编码.md\":\"dc832859\"}")</script>
    <script type="module" async src="/assets/app.79b189f8.js"></script>
    
  </body>
</html>
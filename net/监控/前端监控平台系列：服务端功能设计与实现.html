<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>背景 | WebCourse</title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/assets/style.49eed234.css">
    <link rel="modulepreload" href="/assets/Home.e02e0cd4.js">
    <link rel="modulepreload" href="/assets/app.79b189f8.js">
    <link rel="modulepreload" href="/assets/net_监控_前端监控平台系列：服务端功能设计与实现.md.ecf7f010.lean.js">
    
    <meta name="twitter:title" content="背景 | WebCourse">
  <meta property="og:title" content="背景 | WebCourse">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="WebCourse, back to home" data-v-675d8756 data-v-cc01ef16><!----> WebCourse</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><!----></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><!----><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#nestjs">nestjs</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#redis">redis</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#redis-hash">redis.hash</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#redis-string">redis.string</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#redis-list">redis.list</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#redis-bitmap">redis.bitmap</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#mysql">mysql</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#sls代替es">sls代替ES</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#流程概览">流程概览</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#表结构设计">表结构设计</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#events">events</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#errors表">errors表</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#event与error的关系">event与error的关系</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#error-tag表与project-tag">errortag表与projecttag</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#project表">project表</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#user-project表">user_project表</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#team表">team表</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#user-team表">user_team表</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#sourcemap表">sourcemap表</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#collect表">collect表</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#错误收集">错误收集</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#错误收集-1">错误收集</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#批量入库">批量入库</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#缓存到redis">缓存到redis</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#获取错误标签">获取错误标签</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#收集错误标签">收集错误标签</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#批量更新入库">批量更新入库</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#告警规则和实现">告警规则和实现</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#告警规则">告警规则</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#实现">实现</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#手动上报-紧急通知">手动上报-紧急通知</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#多重标签搜索">多重标签搜索</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#错误详情（前端）">错误详情（前端）</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#用户行为栈">用户行为栈</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#sourcemap还原">sourcemap还原</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#其他标签">其他标签</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="背景" tabindex="-1">背景 <a class="header-anchor" href="#背景" aria-hidden="true">#</a></h1><p>接着上一个系列的<a href="https://juejin.cn/post/6862559324632252430" target="_blank" rel="noopener noreferrer">前端监控平台系列：JS SDK（已开源）</a>，这篇的主要目的讲下服务端的功能设计与实现</p><h1 id="技术栈" tabindex="-1">技术栈 <a class="header-anchor" href="#技术栈" aria-hidden="true">#</a></h1><h2 id="nestjs" tabindex="-1">nestjs <a class="header-anchor" href="#nestjs" aria-hidden="true">#</a></h2><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnestjs.com%2F" target="_blank" rel="noopener noreferrer">nestjs</a>对TS支持较好，有丰富的装饰器以及开箱即用的依赖注入容器</p><h2 id="redis" tabindex="-1">redis <a class="header-anchor" href="#redis" aria-hidden="true">#</a></h2><h3 id="redis-hash" tabindex="-1">redis.hash <a class="header-anchor" href="#redis-hash" aria-hidden="true">#</a></h3><p>由于错误上报是一个经常性的操作，如果每次都查询数据库比较浪费资源，所以用来存放<code>apikey</code>与项目间的联系等一些需要常用的数据，全部都存在一个<code>hash</code>中是为了跟别的项目区分开，相当于一个命名空间的作用（<code>hash</code>中的<code>key</code>不能设置过期时间）</p><h3 id="redis-string" tabindex="-1">redis.string <a class="header-anchor" href="#redis-string" aria-hidden="true">#</a></h3><p>用来存放用户id信息、项目id信息以及一些高频使用数据，但是切记要设置过期时间，不然一些长期没有用的数据就会残留在<code>redis</code>中</p><h3 id="redis-list" tabindex="-1">redis.list <a class="header-anchor" href="#redis-list" aria-hidden="true">#</a></h3><p>用来实现类似<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rabbitmq.com%2F" target="_blank" rel="noopener noreferrer">RabbitMQ</a>的功能，用于批量计算入库，下文有介绍</p><h3 id="redis-bitmap" tabindex="-1">redis.bitmap <a class="header-anchor" href="#redis-bitmap" aria-hidden="true">#</a></h3><p><code>bitmap</code>用来统计某个标签的数量不仅速度快、支持高并发、占的内存特别少，因为是用二进制来存储每个对应标签的值，首先来了解下bit（位）、byte（字节）、word（字）</p><p><strong>Bit&amp;Byte&amp;Word</strong></p><p>Bit = Binary digIT = 0 or 1</p><p>Byte = a sequence of 8 bits = 00000000, 00000001, ..., or 11111111</p><p>Word = a sequence of N bits where N = 16, 32, 64 depending on the computer</p><p><strong>场景一</strong>：比如我现在需要统计全公司所有人（有10万个员工）的一年内365天的签到记录：</p><ol><li>用数据库来存储，建一张包含时间、员工id，每次有人签到就直接在对应表中<code>insert</code>，<strong>缺点</strong>：如果人数很多并且同时签到，会造成数据库连接池爆炸，不能实时更新。<strong>优点</strong>：存有明细数据，可以查询某一天的某个时刻签到的</li><li>用每天的日期当做<code>bitmap</code>的<code>key</code>，<code>value</code>是<code>userId</code>，一个<code>userId</code>在内存中占了二进制位（bit），比如连续自增<code>userId</code>10万个人签到在内存中占了（12500B ≈ 12K，如果换成<code>hash</code>表，相当与用<code>word</code>来存储，内存至少大了16倍），判断一个人是否签到只需要判断当前<code>userId</code>所处的二进制位是否被占。<strong>缺点</strong>：需要自己在内存中额外建一个map来对应明细数据，比如用户在某天签到的具体时间。<strong>优点</strong>：运行内存速度快、支持高并发，实时查询、插入、更改</li></ol><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c4e680a799a4927988a5510c2126675~tplv-k3u1fbpfcp-watermark.awebp" alt="sdkToEnd"></p><p>员工签到-bitmap</p><p><strong>场景二</strong>：就以本系统的错误标签为例，一个项目会有多个<code>error</code>，一个<code>error</code>会有多个<code>event</code>（<a href="#event%E4%B8%8Eerror%E7%9A%84%E5%85%B3%E7%B3%BB">event与error的关系</a>）,如果想存每个错误的标签集合，后续用来做标签可视化报表或者用来搜索，一个错误是由哪些浏览器版本报的、ip集合、自定义的标签集合等等，至少会有10个以上的标签，用<code>bitmap</code>实现：</p><p>使用bitmap来存储每个错误的标签集合：比如一个错误可能有很多<code>浏览器版本</code>和很多<code>IP</code>，这样做的后果是，一个错误要对应12~15个<code>bitmap</code>，一个<code>bitmap</code>对应一个标签集合，比如IP可能有几十万个，在<code>bitmap</code>中仅仅占了几k的内存，而且还能去重，但是我需要展示这个<code>ip</code>值，所以就需要另建一个表来专门存储唯<code>bitmap</code>对应的值与IP值进行映射，不太好维护，所以最终还是选择了mysql作为存储方式</p><p><strong>总结：</strong></p><ol><li>需要对明细数据进行大量操作的话建议放入数据库</li><li>需要实时统计并且数据量较大时使用bitmap进行快速查找，判重与删除</li></ol><p><strong>参考链接</strong>：</p><ul><li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sohu.com%2Fa%2F300039010_114877" target="_blank" rel="noopener noreferrer">漫画：什么是Bitmap算法？</a></li><li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleriou.github.io%2F2017-12-29-user-tag-sys-on-bitmap%2F" target="_blank" rel="noopener noreferrer">用户标签的存储方案</a></li></ul><h2 id="mysql" tabindex="-1">mysql <a class="header-anchor" href="#mysql" aria-hidden="true">#</a></h2><p>用来存储用户、团队、项目、错误、错误级别的标签、项目级别的标签的结果数据</p><h2 id="sls代替es" tabindex="-1">sls代替ES <a class="header-anchor" href="#sls代替es" aria-hidden="true">#</a></h2><p>由于某些原因所以没有采用<code>Elasticsearch</code>，采用是阿里云的日志服务(sls)，但是由于<code>sls</code>不支持更新已经插入的数据，所以部分表：比如标签集合表还是放入<code>mysql</code>来处理</p><h1 id="功能点" tabindex="-1">功能点 <a class="header-anchor" href="#功能点" aria-hidden="true">#</a></h1><h2 id="流程概览" tabindex="-1">流程概览 <a class="header-anchor" href="#流程概览" aria-hidden="true">#</a></h2><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/551a44f31c524ecb9e581f87dfd13cb7~tplv-k3u1fbpfcp-watermark.awebp" alt="sdkToEnd"></p><p>流程概览</p><h2 id="表结构设计" tabindex="-1">表结构设计 <a class="header-anchor" href="#表结构设计" aria-hidden="true">#</a></h2><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0004b96964a64f5fa7ea228169f53262~tplv-k3u1fbpfcp-watermark.awebp" alt="sdkToEnd"></p><p>表结构概览</p><p>如上图所示，总共有10个表加1个sls(日志服务)，下面就来讲讲每个表的作用与关系</p><h3 id="events" tabindex="-1">events <a class="header-anchor" href="#events" aria-hidden="true">#</a></h3><p>用来存放用户行为、错误栈、标签信息、错误信息，每条错误上报后最终都会存入<code>events</code>中，放到<code>sls</code>中的原因是<code>sls</code>对TB级数据多重条件搜索也只要几百毫秒。</p><h3 id="errors表" tabindex="-1">errors表 <a class="header-anchor" href="#errors表" aria-hidden="true">#</a></h3><p>用来存放错误状态、错误影响用户量、错误事件数、错误等级、错误所属项目id、错误所属开发人员等等</p><h3 id="event与error的关系" tabindex="-1">event与error的关系 <a class="header-anchor" href="#event与error的关系" aria-hidden="true">#</a></h3><p>一个<code>error</code>对应多个<code>events</code>。比如现在有两台电脑同时访问同一页面，这个页面有个接口报错，比如是<code>500服务器内部异常</code>，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FclouDr-f2e%2Fmitojs" target="_blank" rel="noopener noreferrer">MITO-SDK</a>会根据接口地址、错误类型:<code>http</code>、状态码、请求方法进行<code>hashCode</code>生成<code>errorId</code>，如果这些参数是一样的话，那么<code>hashCode</code>出来得<code>errorId</code>也应该是一样的，那么这一个<code>error</code>会被推入到<code>mysql</code>，这两个<code>event</code>会分别被推入到<code>sls</code>，虽然是同一个<code>error</code>，但是这两个<code>event</code>的标签不一样：比如<code>ip</code>、浏览器版本等等</p><h3 id="error-tag表与project-tag" tabindex="-1">error_tag表与project_tag <a class="header-anchor" href="#error-tag表与project-tag" aria-hidden="true">#</a></h3><p>了解了<strong>event与error的关系</strong>，<code>error_tag表</code>用来收集错误级别下面所有事件的标签种类和数量，用来统计某个错误下的<strong>标签集合</strong>，<code>project_tag表</code>用来收集项目级别下的所有错误的所有的事件的标签种类和数量，用来<strong>多重搜索</strong>的下拉框数据显示</p><h3 id="project表" tabindex="-1">project表 <a class="header-anchor" href="#project表" aria-hidden="true">#</a></h3><p>用来存放项目名称、apikey（SDK和project之间的联系）</p><h3 id="user-project表" tabindex="-1">user_project表 <a class="header-anchor" href="#user-project表" aria-hidden="true">#</a></h3><p>用来关联<code>user表</code>和<code>project表</code>的<strong>连接表</strong>，存放用户id和项目id</p><h3 id="team表" tabindex="-1">team表 <a class="header-anchor" href="#team表" aria-hidden="true">#</a></h3><p>存放团队名称、团队通知方式</p><h3 id="user-team表" tabindex="-1">user_team表 <a class="header-anchor" href="#user-team表" aria-hidden="true">#</a></h3><p>用来关联<code>user表</code>和team表`的<strong>连接表</strong>，存放用户id和团队id</p><h3 id="sourcemap表" tabindex="-1">sourcemap表 <a class="header-anchor" href="#sourcemap表" aria-hidden="true">#</a></h3><p>打包后的<code>.js</code>文件需要有<code>.map</code>才能还原出生产环境的代码，用来存放.js和.map文件的地址</p><h3 id="collect表" tabindex="-1">collect表 <a class="header-anchor" href="#collect表" aria-hidden="true">#</a></h3><p>存放用户id、错误id，表示用户收藏了哪些错误</p><h2 id="错误收集" tabindex="-1">错误收集 <a class="header-anchor" href="#错误收集" aria-hidden="true">#</a></h2><p>SDK在客户端负责收集错误并上报到服务端，服务端需提供一个接口用来保存错误信息，由于SDK是存放于客户端，所以并发量会比较高，如果采取单条错误过来后，直接计算影响用户数和一些结果数据并且直接入库，这样会导致数据库连接池崩溃，服务端的压力也会因为并发量的增加逐渐崩溃。</p><h3 id="错误收集-1" tabindex="-1">错误收集 <a class="header-anchor" href="#错误收集-1" aria-hidden="true">#</a></h3><p>错误收集的部分是交给<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FclouDr-f2e%2Fmitojs" target="_blank" rel="noopener noreferrer">MITO-SDK</a>来完成，通过SDK收集客户端的错误信息，并配置<code>dsn</code>，然后上报到指定服务端</p><h2 id="批量入库" tabindex="-1">批量入库 <a class="header-anchor" href="#批量入库" aria-hidden="true">#</a></h2><h3 id="缓存到redis" tabindex="-1">缓存到redis <a class="header-anchor" href="#缓存到redis" aria-hidden="true">#</a></h3><p>为了缓解高峰期服务端的压力，所有事件抛上来时先将事件需要的信息提取完然后放入<code>redis.list</code>中，然后起一个定时任务来慢慢消费<code>redis.list</code></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f15f38e49684ab5b066832fd60eb384~tplv-k3u1fbpfcp-watermark.awebp" alt="sdkToEnd"></p><p>sdkToEnd</p><h3 id="获取错误标签" tabindex="-1">获取错误标签 <a class="header-anchor" href="#获取错误标签" aria-hidden="true">#</a></h3><ol><li>用户真实IP：利用nginx反向代理，在请求头中添加<code>x-real-ip</code>字段，nginx配置：<code>proxy_set_header x-real-ip $remote_addr;</code>，根据<code>ip</code>获取获取地理位置以及运营商</li><li>根据<code>user-agent</code>字段可以拿到浏览器版本、系统版本、设备等等</li><li>根据SDK上报的数据可以拿到当前错误的类型、sdk版本、自定义标签、trackerId（用户唯一标识）、traceId（请求接口唯一标识）等等</li></ol><h3 id="收集错误标签" tabindex="-1">收集错误标签 <a class="header-anchor" href="#收集错误标签" aria-hidden="true">#</a></h3><p>上面获取了这么多标签，那为什么要收集这些标签呢？有以下几种好处：</p><ul><li>更好的搜索：可以用多重搜索更精确的筛选出部分错误，如下图所示：</li></ul><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ac0bd541a1444c8ab0f7041ef8271e0~tplv-k3u1fbpfcp-watermark.awebp" alt="front_multiple_search"></p><p>多重搜索</p><ul><li><p>查看错误详情时有更多标签信息</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76878d5f405a43a3a518408264d6c157~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>错误标签信息</p></li><li><p>更好的统计标签集合</p></li></ul><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5699c3e6e5a446b9e79645b2c4f3979~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>标签集合统计</p><h3 id="批量更新入库" tabindex="-1">批量更新入库 <a class="header-anchor" href="#批量更新入库" aria-hidden="true">#</a></h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a258b81aafc4623840c354dc711d150~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>批量入库概览</p><p>比如3分钟的定时任务从<code>redis.list</code>中获取前面100条数据，在服务器处理的时间内，可能错误会再次被推上来，所以需要结束时再进行一次计算。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fedb21caffc3485ea10114bec26495d1~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>取出数据</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f5b682025234d8293ce2efb693c59d5~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>裁剪redis</p><p><strong>缓存与定时任务的作用</strong>：减少高峰期对数据库频繁读写导致<strong>连接池爆满</strong>，定时任务中批量处理的数据可以适当提高，比如三分钟的定时任务可以处理10000条应该是绰绰有余，这个数值可以根据项目的数量自定义。</p><h2 id="告警规则和实现" tabindex="-1">告警规则和实现 <a class="header-anchor" href="#告警规则和实现" aria-hidden="true">#</a></h2><p>错误收集完，然后就是通知开发者及时解决错误，不管是更新错误状态或者是让开发看到某个错误的存在，但又不能频繁的通知开发者，所以需要制定一套告警规则，这套告警规则还可以根据不同项目来<strong>自定义</strong>。</p><h3 id="告警规则" tabindex="-1">告警规则 <a class="header-anchor" href="#告警规则" aria-hidden="true">#</a></h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fe9b402662c449f9a188aa2c197dacff~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>http告警规则</p><p>每个错误进来会有错误等级区分，比如<code>HTTP_ERROR</code>，第一个错误进来是个<code>p4</code>等级，此时不通知，随着数量和影响用户量的提升，不断升级，比如事件数达到30个事件数就升为<code>p3</code>这时就应该通知到对应项目负责人，达到60个时再升一级并且再次通知对应负责人，当数量达到500时升为<code>p1</code>级，此时事件数已经足够庞大，我们就可以认定为这个错误必须要解决（或者选择忽视），此时每次错误进来都将会通知对应负责人。当然这个是可以自定义的，每个项目需要根据用户量的大小不同，设置不同的等级制度</p><p><strong>不同项目对应等级数量不同</strong></p><p>比如项目A的日活（日活跃用户数量）有：50、项目B的日活有：10000，那么需要将FetchRule的调整下：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b33018d219b84e5590fe63f71f3b94f7~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p><strong>错误状态总共有以下五种</strong></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e78d8bc962742b488d0b68ab2e5a1a5~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>错误状态</p><ul><li><strong>未解决</strong></li></ul><p>一个错误上报后默认就是未解决状态。<strong>可以被更改成：解决中、已忽视</strong></p><ul><li><strong>解决中-状态(solving)</strong></li></ul><p>如果你在监控平台上看到该错误，并且认为它需要被解决，但是又不想被同一个错误一直通知，这时将错误状态改为解决中，那么你将会有两小时的时间来修正的错误，在这两个小时内，该错误被再次推进来时，不会通知负责人，并且在两小时后服务端会自动将状态改为<strong>已解决</strong>。如果两小时后被再次触发，那么状态将变成重新打开，并按照正常的告警规则来通知对应开发者。<strong>当前状态不可被更改</strong></p><ul><li><strong>忽视状态-状态(ignored)</strong></li></ul><p>如果等级已经达到<code>p1</code>后，但是你认为这个错误暂时不想解决或者根本没必要解决，那么可以将改错误置为<strong>忽视</strong>状态</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1764b26b54fb488a914c13a948979947~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>已忽视错误状态</p><p>如果置为忽视状态时，那么这个错误升到<code>p1</code>级也不会通知对应负责人。<strong>当前状态可以被更改成：解决中</strong></p><ul><li><strong>重新打开</strong></li></ul><p>如果一个错误被改为<strong>已解决</strong>后，这时又上报了一个错误，状态就变成<strong>重新打开</strong>，后续的告警通知还是走正常流程。<strong>当前状态可以被更改成：解决中、已忽视</strong></p><h3 id="实现" tabindex="-1">实现 <a class="header-anchor" href="#实现" aria-hidden="true">#</a></h3><p>把状态改为解决中，两小时内不会再发通知，两小时后自动把状态改为已解决？怎么实现在两小时内不通知，并且在2小时后自动将状态改为已解决：</p><p>在redis中设置一个过期时间为2小时的key，并在设置完成的回调函数里面添加<code>setTimeout</code>，2小时后就可以处理一些逻辑，但是有个问题，如果此时，服务端重新发版后，这些<code>setTimeout</code>会消失掉，怎么破？这时需要借助<code>redis.hash</code>：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93b7bc5d5947446b8ebf750d5d91f80f~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>延迟更改解决状态</p><p>借助<code>redis.hash</code>的持久缓存，<code>hash.key</code>是错误id，<code>hash.value</code>是到期时间戳，那么就算发版后，重新读下<code>redis.hash</code>重新启动这些<code>setTimeout</code>就可以了。在这两小时中，凡是有错误上报，判断状态是解决中就不告警通知</p><h3 id="手动上报-紧急通知" tabindex="-1">手动上报-紧急通知 <a class="header-anchor" href="#手动上报-紧急通知" aria-hidden="true">#</a></h3><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FclouDr-f2e%2Fmitojs" target="_blank" rel="noopener noreferrer">MITO-SDK</a>可以支持手动上报数据的，假如有如下场景：在某个重要支付界面，你在一些重要的代码起前面加了<code>trycatch</code>，一旦报错了需要第一时间通知到自己，这时就可以用<code>MITO.log()</code>，这个方法可以传错误等级，下面代码传了<code>level:critical</code>，在服务端对应的是<code>p1</code>等级，也是说每次传进来这个错误都会通知对应负责人</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6be3bce63ff3400ba280f99cb6ab5fcc~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>MITO.log上报p1错误</p><h3 id="多重标签搜索" tabindex="-1">多重标签搜索 <a class="header-anchor" href="#多重标签搜索" aria-hidden="true">#</a></h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e28a8b0a57bf45ad9db99ae12d0fecb7~tplv-k3u1fbpfcp-watermark.awebp" alt="front_multiple_search"></p><p>多重标签数据显示</p><p>需要做到标签数据下拉框，需要用到<code>project_tag表</code>，这个表收集了项目级别的所有标签，具体怎么批量收集上面已经讲过(<a href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0%E5%85%A5%E5%BA%93">批量更新入库</a>)，每次切换项目时，对应的标签数据也是不同的。拿到标签后需要到sls中搜索并去重得到<code>errorId</code>数组，然后通过查询<code>errors表</code>进一步对当前<code>errorId</code>数组进行过滤、排序、分页，最终返回给前端</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fae93458386347b59691d80b8b07eb6d~tplv-k3u1fbpfcp-watermark.awebp" alt="front_multiple_search"></p><p>多重标签搜索流程</p><h2 id="错误详情（前端）" tabindex="-1">错误详情（前端） <a class="header-anchor" href="#错误详情（前端）" aria-hidden="true">#</a></h2><p>下面是部分错误详情的组件前端展示：</p><h3 id="用户行为栈" tabindex="-1">用户行为栈 <a class="header-anchor" href="#用户行为栈" aria-hidden="true">#</a></h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8dc9746b3f4e4945a736a74895c51c89~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>用户行为栈是<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FclouDr-f2e%2Fmitojs" target="_blank" rel="noopener noreferrer">MITO-SDK</a>收集的信息，可以配置栈的个数。主要是作用是：查看某个错误触发时的上下文，比如某个接口报错，通过用户行为栈可以看出来在这个接口触发前用户做了哪些事。</p><h3 id="sourcemap还原" tabindex="-1">sourcemap还原 <a class="header-anchor" href="#sourcemap还原" aria-hidden="true">#</a></h3><p>利用<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fsource-map" target="_blank" rel="noopener noreferrer">source-map</a>进行还原操作，将打包后的<code>js</code>还原成开发环境下的<code> . vue</code>或者<code>.js</code>文件。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63ad2a121490485dad71d5dbf83e6597~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>sourcemap还原前</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60d7d891664d4ff99d1ce759fa6da468~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><p>sourcemap还原后</p><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjoeyguo%2Fnoerror" target="_blank" rel="noopener noreferrer">示例参考noerror</a>:用sourcemap包还原打包后的js</p><h3 id="其他标签" tabindex="-1">其他标签 <a class="header-anchor" href="#其他标签" aria-hidden="true">#</a></h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b26a4cadba64b0b92fa422e6951eb9d~tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p><h1 id="结尾" tabindex="-1">结尾 <a class="header-anchor" href="#结尾" aria-hidden="true">#</a></h1><p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FclouDr-f2e%2Fmitojs" target="_blank" rel="noopener noreferrer">开源监控-SDK</a>：将会支持react、小程序、更多hook</strong></p><p><strong>后续可能用放出<code>saas</code>服务免费使用</strong></p><p><strong>期待下一篇：页面性能监控的实践</strong></p><p><strong>点击关注，不迷路！！！每周都会翻译或原创高质量文章哦！！！</strong></p><p>作者：智云健康大前端团队 链接：<a href="https://juejin.cn/post/6901179615188877325" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6901179615188877325</a> 来源：稀土掘金 著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><!----></div></div><div class="updated" data-v-fb8d84c6><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"base_angular_index.md\":\"b7fb98d8\",\"base_aot_aot.md\":\"c43520f0\",\"base_babel_advanced.md\":\"63d342bd\",\"base_babel_babel.md\":\"08db37cd\",\"base_babel_index.md\":\"7eeed92e\",\"base_c_index.md\":\"b4d74b36\",\"base_centos_index.md\":\"a9a38139\",\"base_chrome.google_chrome.md\":\"9ab68b28\",\"base_chrome_chrome.md\":\"d5478063\",\"base_css_css.md\":\"53cfe2c2\",\"base_docker_index.md\":\"ce74c680\",\"base_eclipse_index.md\":\"237a2a6a\",\"base_element_index.md\":\"89357051\",\"base_eslint_ellint.md\":\"ed5245f3\",\"base_git_git.md\":\"94bdb8c9\",\"base_git_index.md\":\"0703fa56\",\"base_gitee_gitee.md\":\"cab28a11\",\"base_index.md\":\"2c3d9022\",\"base_javascript_index.md\":\"763b15a0\",\"base_jenkins_index.md\":\"4f161285\",\"base_k8s_changelog.md\":\"b3602f66\",\"base_k8s_index.md\":\"7566b1e3\",\"base_lerna_index.md\":\"c101cd05\",\"base_linux_desktop-environment_desktop-environment.md\":\"e98166a4\",\"base_linux_distribution_fedora_fedora.md\":\"27cd3611\",\"base_linux_distribution_deepin_deepin.md\":\"6d619bd8\",\"base_linux_distribution_release-linux.md\":\"b9f41044\",\"base_linux_index.md\":\"3b9628c0\",\"base_linux_linux运维管理.md\":\"131c0685\",\"base_markdown_markdown.md\":\"d0c50375\",\"base_node_index.md\":\"82ac46bf\",\"base_node_package.json.md\":\"5dcd94a1\",\"base_npm_index.md\":\"77335796\",\"base_pnpm_index.md\":\"3720ecc2\",\"base_rancher_rancher_v1.x.md\":\"737d5024\",\"base_sprint_sprintboot_index.md\":\"a3803d2f\",\"base_typescript_typescript 2.md\":\"5c9d9fc7\",\"base_typescript_typescript.md\":\"2107d092\",\"base_v8_index.md\":\"ff3988a2\",\"base_vite_index.md\":\"8c652462\",\"base_vite_vite.md\":\"2a219f01\",\"base_vitepress_index.md\":\"1d84b7f6\",\"base_vscode_configuration.md\":\"0544a770\",\"base_vscode_devextension.md\":\"943eea8d\",\"base_vscode_index.md\":\"fd79141e\",\"base_vscode_index的副本.md\":\"c01426cf\",\"base_vscode_setting.vscode.wit.md\":\"e7d097ce\",\"base_vscode_vscode.md\":\"dbf5c04b\",\"base_vue_cli.md\":\"887006a7\",\"base_vue_compile 2.md\":\"abcbe179\",\"base_vue_compile.md\":\"3bc59f4f\",\"base_vue_composition-api-vue2.md\":\"e7ddbfa4\",\"base_vue_index 2.md\":\"7a06bd7b\",\"base_vue_index.md\":\"f58fe564\",\"base_vue_rule 2.md\":\"d05982e0\",\"base_vue_rule.md\":\"50c0dde7\",\"base_vue_vuecli_index.md\":\"f17a3bc1\",\"base_vuecli_index.md\":\"141ebc83\",\"base_wechat_index.md\":\"9feec7b6\",\"base_windows_window.md\":\"8a580416\",\"base_windows_windows.md\":\"5dbcbfed\",\"base_winget_index.md\":\"85597476\",\"base_winget_package.json.md\":\"494751ea\",\"base_yarn_index.md\":\"169d3711\",\"data_常用算法.md\":\"fb437b77\",\"data_数据结构.md\":\"f105a4dc\",\"data_算法题.md\":\"e7f551f0\",\"economics_daikuan.md\":\"5fbc18c8\",\"hardware_car_jeep_index.md\":\"d5c72757\",\"hardware_index.md\":\"9a014f54\",\"hardware_ipad.md\":\"bd7dc48e\",\"hardware_keyboard_index.md\":\"5a8e9df6\",\"hardware_pc.md\":\"f80bac39\",\"hardware_phone.md\":\"1f8b0565\",\"hardware_人体工学椅.md\":\"3663023d\",\"hardware_接口.md\":\"1941bec4\",\"index.md\":\"5e61c665\",\"net_56_109.md\":\"73f3cbb2\",\"net_56_110.md\":\"1bf4285c\",\"net_56_index.md\":\"7d8e261d\",\"net_netprotocal_http_index.md\":\"f374b289\",\"net_netprotocal_http2_index.md\":\"a743506a\",\"net_netprotocal_index.md\":\"29fe4819\",\"net_browser_index.md\":\"356857d9\",\"net_domains_index.md\":\"2b1ab77b\",\"net_gfw.md\":\"4ac408c0\",\"net_index 2.md\":\"03d74029\",\"net_index.md\":\"bf0e58ce\",\"net_监控_index.md\":\"c87f8a3c\",\"net_监控_前端监控 sdk 的一些技术要点原理分析.md\":\"94fb4204\",\"net_监控_前端监控平台系列：js sdk（已开源）.md\":\"994dd3cf\",\"net_监控_前端监控平台系列：服务端功能设计与实现.md\":\"ecf7f010\",\"net_网络协议_index.md\":\"d81eebe7\",\"net_路由器_路由器.md\":\"7b473456\",\"os_filesystem.md\":\"94224199\",\"os_cardos_index.md\":\"6a54979f\",\"os_kernel-windows.md\":\"95305664\",\"os_uos_index.md\":\"b24fb656\",\"os_windows_windows-kernel_filesystem-windows.md\":\"e781039b\",\"os_windows_windows-kernel_powershell.md\":\"087cf6fd\",\"os_windows_windows-kernel_tools-windows.md\":\"879becc1\",\"os_windows_windows-kernel_windows.md\":\"74542254\",\"os_windows_windows-kernel_垃圾清理.md\":\"a61d7f0f\",\"software_a-tools.md\":\"2d8b3a4d\",\"software_browser_index.md\":\"4c792ac1\",\"software_download-tools.md\":\"6b3fce1a\",\"software_index.md\":\"e824bbad\",\"software_news21-05.hardware.md\":\"92971134\",\"software_news21.software.md\":\"3f581dd7\",\"todos_index.md\":\"e0ca8b4d\"}")</script>
    <script type="module" async src="/assets/app.79b189f8.js"></script>
    
  </body>
</html>